## Api Refference

[WiFi: Staging](http://docs.wifi3.apiary.io)

<!-- Почтовая рассылка -->
** Функционал страницы с поздравлениями **
  - [x] Две формы: email и sms
  - [x] Размер сообщения для email не больше 500 символов
  - [x] Размер сообщения для sms не больше 140 символов
  - [ ] Переключатель процесса рассылки на email
  - [ ] Переключатель процесса рассылки через sms
  - [ ] Два селектора для выбора периода рассылки (день/неделя) для каждого способа
  - [ ] Указание количества смс, которые хочет потратить пользователь
  - [ ] Модерация сообщений?
  - [ ] Интекграция #{ имени } пользователя в сообщение
  - [ ] Гайд по интеграции #{ имени } пользователя через *placeholder*
  - [x] Валидации форм
  - [ ] Сообщение о старте рассылок или об ошибке
  - [ ] Big red warning!!!
  - [ ] Ограничение по рассылке: не больше сотни в день или в месяц или ещё как


## New login

- [x] 1. Точка входа - никакой информации пока нет
  - [x] 1.1 Получаем от роутера мак-адрес устройства и ищем по нему client_device
  - [x] 1.1 Если client_device найден, получаем client_id из него
  - [x] 1.2 если не найден - создаём ClientDevice и Client

- [x] 2. Проверка номера телефона и социального аккаунта: в этой точке известны client_device_id и client_id.  
 У клиента может быть phone_number=null
 - [x] 2.1 Если у клиента phone_number не null
  - [x] 2.1.1 проверяем sms_log. Если дата на шесть месяцев или более раньше текущей - переходим к шагу 3  
  - [x] 2.1.2 ищем последний social_account с таким client_id и (provider не password) и (дата создания > текущая дата - месяц) и (client_id != 42)
  - [x] 2.1.3 если нашли social-account
    - [x] 2.1.3.1 пишем в social_logs
    - [x] 2.1.3.2 пишем в AuthLog
    - [x] 2.1.3.3 переходим к пункту 5
  - [x] 2.1.4 если не нашли social_account или client_id == 42 - переходим к шагу 4
 - [x] 2.2 Если у клиента phone_number == null - переходим к шагу 3

- [x] 3. Отправка и проверка смс. В этой точке известны client_device_id и client_id. У клиента может быть phone_number=null
  - [x] 3.1 Проверяем счётчик отправленных смс в локации, количество оставшихся смс и свойство "sms_auth" у локации и/или бренда
  - [x] 3.2 Если у локации остались смс и sms_auth == true
    - [x] 3.2.1 выводим текст "авторизация по смс в соответствии с законом", финальный текст я потом поправлю в переводах
    - [x] 3.2.2 пользователь вводит номер телефона
    - [x] 3.2.3 отправляем смс и запрашиваем контрольный код
    - [x] 3.2.4 пользователь вводит код. если код не совпал - возвращаемся к 3.2
    - [x] 3.2.5 ищем в Clients номер телефона клиента
    - [x] 3.2.6 если клиента с таким номером телефона в базе нет
      - [x] 3.2.6 сохраняем phone_number в clients
      - [x] 3.2.6.1 сохраняем phone_number в clients с нашим client_id
    - [x] 3.2.7 если в базе уже есть такой телефонный номер
      - [x] 3.2.7.1 удаляем из Clients клиента с нашим client_id
      - [x] 3.2.7.2 получаем по номеру телефона client_id существующего клиента и кладём его в redis
      - [x] 3.2.7.3 обновляем значение client_id в client_device
  - [x] 3.3 Если смс не осталось или sms_auth == false
    - [x] 3.3.1 удаляем из Clients клиента с нашим client_id
    - [x] 3.3.2 используем вместо созданного на первом шаге клиента с client_id = 42
    - [x] 3.3.3 обновляем значение client_id в client_device
  - [x] 3.4 Переходим к шагу 4

- [x] 4. Форма со списком соцсетей и входом по паролю  
(кнопку, которая щас названа "авторизоваться по SMS" переименуем в "войти без социальной сети"):  
в этой точке у клиента уже не может быть phone_number=null.
  - [x] 4.1 выводим список соцсетей
  - [x] 4.2 если клиент выбрал соцсеть и авторизовался в ней
    - [x] 4.2.1 находим или создаём social_account с client_id и provider соцсети
    - [x] 4.2.2 вытаскиваем данные из соцсети и обновляем social_account
  - [x] 4.3 если клиент выбрал "войти без социальной сети" -  
  находим или создаём social_account с нашим client_id и provider='password'
  - [x] 4.4 пишем запись в social_logs
  - [x] 4.5 пишем запись в auth_logs

- [x] 5. Промо-страница. Пока просто выводим promo_text. К этому моменту у нас должны быть созданы записи в social_logs и auth_logs

- [x] 6. Последний шаг - невидимая форма с display:none и автоматическим submit. Здесь у нас уже есть social_account_id
  - [x] 6.1 автоматически submit - редирект на link_login_only - как было на странице "пора в интернет"
